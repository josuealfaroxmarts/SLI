<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_mro_order_detail_document">
        <t t-call="fleet_mro.fleet_mro_layout">
            <t t-set="doc" t-value="doc.with_context({'lang':doc.partner_id.lang})" />
            <div class="page">
                <div class="row">
                    <strong>Service Order: <span t-field="doc.name"/></strong>
                    <p t-if="doc.internal_repair">Internal Repair</p>
                </div>
                <table class="table table-condensed" style="page-break-inside: avoid">
                    <tr style="font-weight:bold;background-color: #f2f2f2">
                        <td width="25%" style="text-align:center;font-size: 10px">Date</td>
                        <td width="25%" style="text-align:center;font-size: 10px">Warehouse</td>
                        <td width="25%" style="text-align:center;font-size: 10px">Operating Unit</td>
                        <td width="25%" style="text-align:center;font-size: 10px">Supervisor</td>
                    </tr>
                    <tr>
                        <td style="text-align:center;font-size: 10px"><p t-field="doc.date"/></td>
                        <td style="text-align:center;font-size: 10px"><p t-field="doc.warehouse_id.name"/></td>
                        <td style="text-align:center;font-size: 10px"><p t-field="doc.operating_unit_id.name"/></td>
                        <td style="text-align:center;font-size: 10px"><p t-field="doc.supervisor_id.name"/></td>
                    </tr>
                    <tr style="font-weight:bold;background-color: #f2f2f2">
                        <td style="text-align:center;font-size: 10px">Vehicle</td>
                        <td style="text-align:center;font-size: 10px">Odometer</td>
                        <td style="text-align:center;font-size: 10px">Driver</td>
                        <td style="text-align:center;font-size: 10px">Service Type</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="text-align:center;font-size: 10px"><p t-field="doc.vehicle_id.name"/></td>
                        <td style="text-align:center;font-size: 10px"><p t-field="doc.accumulated_odometer"/></td>
                        <td style="text-align:center;font-size: 10px"><p t-field="doc.driver_id.name"/></td>
                        <td style="text-align:center;font-size: 10px"><p t-field="doc.mro_type_id.name"/></td>
                    </tr>
                </table>



                <table class="table table-condensed">
                    <thead>
                        <tr style="font-weight:bold;background-color: #A9A9A9">
                            <th style="text-align:center;font-size: 8px">Task</th>
                            <th style="text-align:right;font-size: 8px" >Income</th>
                            <th style="text-align:right;font-size: 8px" >Spare Parts</th>
                            <th style="text-align:right;font-size: 8px" >WorkHand</th>
                            <th style="text-align:right;font-size: 8px" >Spare Parts Ext.</th>
                            <th style="text-align:right;font-size: 8px" >WorkHand Ext.</th>
                            <th style="text-align:right;font-size: 8px" >All Costs</th>
                            <th style="text-align:right;font-size: 8px" >Profit/Loss</th>
                        </tr>
                    </thead>
                    <tbody class="sale_tbody">
                        <t t-set="var_price_subtotal" t-value="0.0"/>
                        <t t-set="var_parts_cost" t-value="0.0"/>
                        <t t-set="var_cost_service" t-value="0.0"/>
                        <t t-set="var_parts_cost_external" t-value="0.0"/>
                        <t t-set="var_cost_service_external" t-value="0.0"/>
                        <t t-set="var_cost_all" t-value="0.0"/>
                        <t t-set="var_profit_loss" t-value="0.0"/>
                        
                        <t t-foreach="doc.task_ids" t-as="l">
                            <tr style="font-weight:bold;background-color: #B9B9B9">
                                <td style="font-size: 8px"><span t-field="l.name"/></td>
                                <td style="text-align:right;font-size: 8px" ><span t-field="l.price_subtotal" /></td>
                                <td style="text-align:right;font-size: 8px" ><span t-field="l.parts_cost" /></td>
                                <td style="text-align:right;font-size: 8px" ><span t-field="l.cost_service" /></td>
                                <td style="text-align:right;font-size: 8px" ><span t-field="l.parts_cost_external" /></td>
                                <td style="text-align:right;font-size: 8px" ><span t-field="l.cost_service_external" /></td>
                                <td style="text-align:right;font-size: 8px" ><span t-field="l.cost_all" /></td>
                                <td style="text-align:right;font-size: 8px" ><span t-field="l.profit_loss" /></td>
                            </tr>
                            <t t-set="var_price_subtotal"   t-value="var_price_subtotal + l.price_subtotal"/>
                            <t t-set="var_parts_cost"       t-value="var_parts_cost + l.parts_cost"/>
                            <t t-set="var_cost_service"     t-value="var_cost_service + l.cost_service"/>
                            <t t-set="var_parts_cost_external" t-value="var_parts_cost_external + l.parts_cost_external"/>
                            <t t-set="var_cost_service_external" t-value="var_cost_service_external + l.cost_service_external"/>
                            <t t-set="var_cost_all"         t-value="var_cost_all + l.cost_all"/>
                            <t t-set="var_profit_loss"      t-value="var_profit_loss + l.profit_loss"/>
                            
                            <!-- Spare Parts Detailed -->
                            <t t-if="not(l.stock_move_ids and any(((sm1.location_id.usage=='internal' or sm1.location_dest_id.usage=='internal') and sm1.state=='done') for sm1 in l.stock_move_ids))">
                                <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 8px;">
                                    <td colspan="8">No Spare Parts</td>
                                </tr>
                            </t>
                            <t t-if="l.stock_move_ids and any(((sm1.location_id.usage=='internal' or sm1.location_dest_id.usage=='internal') and sm1.state=='done') for sm1 in l.stock_move_ids)">
                                <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 8px;">
                                    <td colspan="8">Spare Parts Detailed</td>
                                </tr>
                                <tr>
                                    <td colspan="8">
                                        <table class="table table-condensed">
                                            <thead>
                                                <tr style="font-weight:bold;background-color: #f2f2f2;">
                                                    <td style="font-size: 8px;text-align:center;">Date</td>
                                                    <td style="font-size: 8px;text-align:center;">Picking</td>
                                                    <td style="font-size: 8px;text-align:center;">Spare Part</td>
                                                    <td style="font-size: 8px;text-align:right;">Qty</td>
                                                    <td style="font-size: 8px;text-align:center;">UoM</td>
                                                    <td style="font-size: 8px;text-align:right;">Cost Unit</td>
                                                    <td style="font-size: 8px;text-align:right;">Amount</td>
                                                    <td style="font-size: 8px;text-align:center;">Stock Location Origin</td>
                                                    <td style="font-size: 8px;text-align:center;">Stock Location Destiny</td>
                                                    <td style="font-size: 8px;text-align:center;">State</td>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-set="var_spare_parts_sum" t-value="0.0"/>
                                                <t t-foreach="l.stock_move_ids" t-as="sm">
                                                    <t t-if="(sm.location_id.usage=='internal' or sm.location_dest_id.usage=='internal') and sm.state=='done'">
                                                        <tr style="font-size: 8px;">
                                                            <td style="text-align:center;" ><span t-field="sm.date" /></td>
                                                            <td style="text-align:center;" ><span t-field="sm.picking_id.name" /></td>
                                                            <td ><span t-field="sm.product_id.name" /></td>
                                                            <td style="text-align:right;" ><t t-esc="'{0:,.2f}'.format(int((sm.location_dest_id.usage in ('production','inventory') and 1.0 or -1.0) * sm.product_uom_qty))" /></td>
                                                            <td style="text-align:center;" ><span t-field="sm.product_uom.name" /></td>
                                                            <td style="text-align:right;" ><span t-field="sm.price_unit" /></td>
                                                            <td style="text-align:right;" ><t t-esc="'{0:,.2f}'.format(int((sm.location_dest_id.usage in ('production','inventory') and 1.0 or -1.0) * sm.product_uom_qty * sm.price_unit))" /></td>
                                                            <td style="text-align:center;" ><span t-field="sm.location_id.complete_name" /></td>
                                                            <td style="text-align:center;" ><span t-field="sm.location_dest_id.complete_name" /></td>
                                                            <td style="text-align:center;" ><span t-field="sm.state" /></td>
                                                        </tr>
                                                        <t t-set="var_spare_parts_sum" t-value="var_spare_parts_sum + ((sm.location_dest_id.usage in ('production','inventory') and 1.0 or -1.0) * sm.product_uom_qty * sm.price_unit)"/>
                                                    </t>
                                                </t>
                                            </tbody>
                                            <tfoot>
                                                <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 8px;">
                                                    <td style="text-align:right;" colspan="6">Spare Parts Sum: </td>
                                                    <td style="text-align:right;"><t t-esc="'{0:,.2f}'.format(int(var_spare_parts_sum))" /></td>
                                                    <td style="text-align:center;" colspan="3">· · ·</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </td>
                                </tr>
                            </t>
                          <!-- Internal Manpower -->
                            <t t-if="not(l.control_time_ids)">
                                <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 8px;">
                                    <td colspan="8">No Manpower Detailed</td>
                                </tr>
                            </t>
                            <t t-if="l.control_time_ids">
                                <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 8px;">
                                    <td colspan="8">Manpower Detailed</td>
                                </tr>
                                <tr>
                                    <td colspan="8">
                                        <table class="table table-condensed">
                                            <thead>
                                                <tr style="font-weight:bold;background-color: #f2f2f2;">
                                                    <td style="font-size: 8px;">Mechanic</td>
                                                    <td style="font-size: 8px;text-align:center;">Start Date</td>
                                                    <td style="font-size: 8px;text-align:center;">End Date</td>
                                                    <td style="font-size: 8px;text-align:right;">Duration</td>
                                                    <td style="font-size: 8px;text-align:right;">Price Unit</td>
                                                    <td style="font-size: 8px;text-align:right;">Amount</td>
                                                    <td style="font-size: 8px;text-align:center;">State</td>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-set="var_manpower_sum" t-value="0.0"/><t t-set="var_manpower_hours_sum" t-value="0.0"/>
                                                <t t-foreach="l.control_time_ids" t-as="timesheet">
                                                    <t t-if="l.state=='done'">
                                                        <tr style="font-size: 8px">
                                                            <td ><span t-field="timesheet.hr_employee_id.name" /></td>
                                                            <td style="text-align:center;" ><span t-field="timesheet.date_start" /></td>
                                                            <td style="text-align:center;" ><span t-field="timesheet.date_end" /></td>
                                                            <td style="text-align:right;" ><t t-esc="'{0:,.2f}'.format(int(timesheet.hours_mechanic))" /></td>
                                                            <td style="text-align:right;" ><t t-esc="'{0:,.2f}'.format(int(timesheet.price_unit))" /></td>
                                                            <td style="text-align:right;" ><t t-esc="'{0:,.2f}'.format(int(timesheet.amount))" /></td>
                                                            <td style="text-align:center;" ><span t-field="timesheet.state" /></td>
                                                        </tr>
                                                        <t t-set="var_manpower_hours_sum" t-value="var_manpower_hours_sum + timesheet.hours_mechanic"/>
                                                        <t t-set="var_manpower_sum" t-value="var_manpower_sum + timesheet.amount"/>
                                                    </t>
                                                </t>
                                            </tbody>
                                            <tfoot>
                                                <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 8px;">
                                                    <td style="text-align:right;" colspan="3">Manpower Sum: </td>
                                                    <td style="text-align:right;"><t t-esc="'{0:,.2f}'.format(int(var_manpower_hours_sum))" /></td>
                                                    <td style="text-align:center;" >···</td>
                                                    <td style="text-align:right;"><t t-esc="'{0:,.2f}'.format(int(var_manpower_sum))" /></td>
                                                    <td style="text-align:center;" >···</td>
                                                </tr>
                                            </tfoot>                                            
                                        </table>
                                    </td>
                                </tr>
                            </t>

******                            <!-- Spare Parts External Detailed -->
                            <t t-if="not(l.stock_move_ids and any(((sm1.location_id.usage=='supplier' or sm1.location_dest_id.usage=='supplier') and sm1.state=='done') for sm1 in l.stock_move_ids))">
                                <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 8px;">
                                    <td colspan="8">No Spare Parts from External Workshop</td>
                                </tr>
                            </t>
                            <t t-if="l.stock_move_ids and any(((sm1.location_id.usage=='supplier' or sm1.location_dest_id.usage=='supplier') and sm1.state=='done') for sm1 in l.stock_move_ids)">
                                <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 8px;">
                                    <td colspan="8">Spare Parts from External Workshop Detailed</td>
                                </tr>
                                <tr>
                                    <td colspan="8">
                                        <table class="table table-condensed">
                                            <thead>
                                                <tr style="font-weight:bold;background-color: #f2f2f2;">
                                                    <td style="font-size: 8px;text-align:center;">Date</td>
                                                    <td style="font-size: 8px;text-align:center;">Picking</td>
                                                    <td style="font-size: 8px;text-align:center;">Spare Part</td>
                                                    <td style="font-size: 8px;text-align:right;">Qty</td>
                                                    <td style="font-size: 8px;text-align:center;">UoM</td>
                                                    <td style="font-size: 8px;text-align:right;">Cost Unit</td>
                                                    <td style="font-size: 8px;text-align:right;">Amount</td>
                                                    <td style="font-size: 8px;text-align:center;">Stock Location Origin</td>
                                                    <td style="font-size: 8px;text-align:center;">Stock Location Destiny</td>
                                                    <td style="font-size: 8px;text-align:center;">State</td>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-set="var_spare_parts_sum" t-value="0.0"/>
                                                <t t-foreach="l.stock_move_ids" t-as="sm">
                                                    <t t-if="(sm.location_id.usage=='supplier' or sm.location_dest_id.usage=='supplier') and sm.state=='done'">
                                                        <tr style="font-size: 8px;">
                                                            <td style="text-align:center;" ><span t-field="sm.date" /></td>
                                                            <td style="text-align:center;" ><span t-field="sm.picking_id.name" /></td>
                                                            <td ><span t-field="sm.product_id.name" /></td>
                                                            <td style="text-align:right;" ><t t-esc="'{0:,.2f}'.format(int((sm.location_dest_id.usage in ('production','inventory') and 1.0 or -1.0) * sm.product_uom_qty))" /></td>
                                                            <td style="text-align:center;" ><span t-field="sm.product_uom.name" /></td>
                                                            <td style="text-align:right;" ><span t-field="sm.price_unit" /></td>
                                                            <td style="text-align:right;" ><t t-esc="'{0:,.2f}'.format(int((sm.location_dest_id.usage in ('production','inventory') and 1.0 or -1.0) * sm.product_uom_qty * sm.price_unit))" /></td>
                                                            <td style="text-align:center;" ><span t-field="sm.location_id.complete_name" /></td>
                                                            <td style="text-align:center;" ><span t-field="sm.location_dest_id.complete_name" /></td>
                                                            <td style="text-align:center;" ><span t-field="sm.state" /></td>
                                                        </tr>
                                                        <t t-set="var_spare_parts_sum" t-value="var_spare_parts_sum + ((sm.location_dest_id.usage in ('production','inventory') and 1.0 or -1.0) * sm.product_uom_qty * sm.price_unit)"/>
                                                    </t>
                                                </t>
                                            </tbody>
                                            <tfoot>
                                                <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 8px;">
                                                    <td style="text-align:right;" colspan="6">Spare Parts from External Workshop Sum: </td>
                                                    <td style="text-align:right;"><t t-esc="'{0:,.2f}'.format(int(var_spare_parts_sum))" /></td>
                                                    <td style="text-align:center;" colspan="3">· · ·</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </td>
                                </tr>
                            </t>

                            <!-- Manpower External Workshop -->
                            <t t-if="not(l.purchase_order_line_ids and any((pol.product_id.type=='service' and pol.state in ('purchase','done')) for pol in l.purchase_order_line_ids))">
                                <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 8px;">
                                    <td colspan="8">No Manpower from External Workshop</td>
                                </tr>
                            </t>
                            <t t-if="l.purchase_order_line_ids and any((pol.product_id.type=='service' and pol.state in ('purchase','done')) for pol in l.purchase_order_line_ids)">
                                <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 8px;">
                                    <td colspan="8">Manpower from External Workshop Detailed</td>
                                </tr>
                                <tr>
                                    <td colspan="8">
                                        <table class="table table-condensed">
                                            <thead>
                                                <tr style="font-weight:bold;background-color: #f2f2f2">
                                                    <td style="font-size: 8px;text-align:center;">Reference</td>
                                                    <td style="font-size: 8px;">Partner</td>
                                                    <td style="font-size: 8px;text-align:center;">Date</td>
                                                    <td style="font-size: 8px;">Description</td>
                                                    <td style="font-size: 8px;text-align:right;">Qty</td>
                                                    <td style="font-size: 8px;text-align:center;">UoM</td>
                                                    <td style="font-size: 8px;text-align:right;">Price Unit</td>
                                                    <td style="font-size: 8px;text-align:right;">Amount</td>
                                                    <td style="font-size: 8px;text-align:center;">State</td>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-set="var_manpower_ext_sum" t-value="0.0"/>
                                                <t t-foreach="l.purchase_order_line_ids" t-as="po_line">
                                                    <t t-if="po_line.product_id.type=='service' and po_line.state in ('purchase','done')">                                                        
                                                        <tr style="font-size: 8px">
                                                            <td style="text-align:center;"><span t-field="po_line.order_id.name" /></td>
                                                            <td ><span t-field="po_line.partner_id.name" /></td>
                                                            <td style="text-align:center;" ><span t-field="po_line.date_order" /></td>
                                                            <td ><span t-field="po_line.name" /></td>
                                                            <td style="text-align:right;" ><span t-field="po_line.product_qty" /></td>
                                                            <td style="text-align:center;"><span t-field="po_line.product_uom.name" /></td>
                                                            <td style="text-align:right;" ><span t-field="po_line.price_unit" /></td>
                                                            <td style="text-align:right;" ><span t-field="po_line.price_subtotal" /></td>
                                                            <td style="text-align:center;" ><span t-field="po_line.state" /></td>
                                                        </tr>
                                                        <t t-set="var_manpower_ext_sum" t-value="var_manpower_ext_sum + po_line.price_subtotal"/>
                                                    </t>
                                                </t>
                                            </tbody>
                                            <tfoot>
                                                <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 8px;">
                                                    <td style="text-align:right;" colspan="7">Manpower from External Workshop Sum: </td>
                                                    <td style="text-align:right;"><t t-esc="'{0:,.2f}'.format(int(var_manpower_ext_sum))" /></td>
                                                    <td style="text-align:center;">···</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </td>
                                </tr>
                            </t>
                        </t>
                    </tbody>
                    <tfoot class="sale_tbody">                    
                        <tr style="font-weight:bold;background-color: #A9A9A9">
                            <td style="text-align:right;font-size: 8px"><strong>Sum: </strong></td>
                            <td style="text-align:right;font-size: 8px"><t t-esc="'{0:,.2f}'.format(int(var_price_subtotal))" /></td>
                            <td style="text-align:right;font-size: 8px"><t t-esc="'{0:,.2f}'.format(int(var_parts_cost))" /></td>
                            <td style="text-align:right;font-size: 8px"><t t-esc="'{0:,.2f}'.format(int(var_cost_service))" /></td>
                            <td style="text-align:right;font-size: 8px"><t t-esc="'{0:,.2f}'.format(int(var_parts_cost_external))" /></td>
                            <td style="text-align:right;font-size: 8px"><t t-esc="'{0:,.2f}'.format(int(var_cost_service_external))" /></td>
                            <td style="text-align:right;font-size: 8px"><t t-esc="'{0:,.2f}'.format(int(var_cost_all))" /></td>
                            <td style="text-align:right;font-size: 8px"><t t-esc="'{0:,.2f}'.format(int(var_profit_loss))" /></td>
                        </tr>
                    </tfoot>
                </table>
                <p t-field="doc.note" />

                
            </div>
        </t>
    </template>


    <template id="report_mro_order_detail">
        <t t-set="data_report_margin_top" t-value="20"/> 
        <t t-set="data_report_header_spacing" t-value="10"/>
        <t t-set="data_report_dpi" t-value="600"/>    
        <t t-call="report.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="fleet_mro.report_mro_order_detail_document" t-lang="doc.partner_id.lang"/>
            </t>
        </t>
    </template>
</odoo>
