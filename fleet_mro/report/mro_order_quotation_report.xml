<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_mro_order_quotation_document">
        <t t-call="fleet_mro.fleet_mro_layout">
            <t t-set="doc" t-value="doc.with_context({'lang':doc.partner_id.lang})" />
            <div class="page">
                <div class="row">
                    <strong>Service Order Quotation: <span t-field="doc.name"/></strong>
                    <p t-if="doc.internal_repair">Internal Repair</p>
                </div>
                
                <table class="table table-condensed" style="page-break-inside: avoid">
                    <tr style="font-size: 10px;">
                        <td>
                            <strong>Partner:</strong>
                            <div t-field="doc.partner_id"
                                t-options='{"widget": "contact", "fields": ["address", "name", "phone", "fax"], "no_marker": True, "phone_icons": True}'/>                        
                        </td>
                        <td>
                            <strong>Partner Invoice:</strong>
                            <div t-field="doc.partner_invoice_id"
                                t-options='{"widget": "contact", "fields": ["address", "name", "phone", "fax"], "no_marker": True, "phone_icons": True}'/>                        
                            <p t-if="doc.partner_invoice_id.vat">VAT: <span t-field="doc.partner_invoice_id.vat"/></p>
                        </td>
                        <td>
                            <strong>Partner Contact:</strong>
                            <div t-field="doc.partner_contact_id"
                                t-options='{"widget": "contact", "fields": ["address", "name", "phone", "fax"], "no_marker": True, "phone_icons": True}'/>                        
                        </td>
                    </tr>
                </table>
                <table class="table table-condensed" style="page-break-inside: avoid">
                    <tr style="font-weight:bold;background-color: #f2f2f2">
                        <td width="25%" style="text-align:center;font-size: 9px">Date</td>
                        <td width="25%" style="text-align:center;font-size: 9px">Warehouse</td>
                        <td width="25%" style="text-align:center;font-size: 9px">Operating Unit</td>
                        <td width="25%" style="text-align:center;font-size: 9px">Supervisor</td>
                    </tr>
                    <tr>
                        <td style="text-align:center;font-size: 9px"><p t-field="doc.date"/></td>
                        <td style="text-align:center;font-size: 9px"><p t-field="doc.warehouse_id.name"/></td>
                        <td style="text-align:center;font-size: 9px"><p t-field="doc.operating_unit_id.name"/></td>
                        <td style="text-align:center;font-size: 9px"><p t-field="doc.supervisor_id.name"/></td>
                    </tr>
                    <tr style="font-weight:bold;background-color: #f2f2f2">
                        <td style="text-align:center;font-size: 9px">Vehicle</td>
                        <td style="text-align:center;font-size: 9px">Odometer</td>
                        <td style="text-align:center;font-size: 9px">Driver</td>
                        <td style="text-align:center;font-size: 9px">Service Type</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="text-align:center;font-size: 9px"><p t-field="doc.vehicle_id.name"/></td>
                        <td style="text-align:center;font-size: 9px"><p t-field="doc.accumulated_odometer"/></td>
                        <td style="text-align:center;font-size: 9px"><p t-field="doc.driver_id.name"/></td>
                        <td style="text-align:center;font-size: 9px"><p t-field="doc.mro_type_id.name"/></td>
                    </tr>
                    <tr style="font-weight:bold;background-color: #f2f2f2">
                        <td style="text-align:center;font-size: 9px">Your Reference</td>
                        <td style="text-align:center;font-size: 9px">Salesperson</td>
                        <td style="text-align:center;font-size: 9px">Sales Team</td>
                        <td style="text-align:center;font-size: 9px">Payment Terms</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="text-align:center;font-size: 9px"><p t-field="doc.client_order_ref"/></td>
                        <td style="text-align:center;font-size: 9px"><p t-field="doc.user_id"/></td>
                        <td style="text-align:center;font-size: 9px"><p t-field="doc.team_id"/></td>
                        <td style="text-align:center;font-size: 9px"><p t-field="doc.payment_term_id"/></td>
                    </tr>                    
                </table>

                <table class="table table-condensed">
                    <thead>
                        <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 9px;">
                            <!--<th >Product</th>-->
                            <th >Description</th>
                            <th style="text-align:right;" >Quantity</th>
                            <th style="text-align:center;" >UoM</th>
                            <th style="text-align:right;" >Price Unit</th>
                            <th style="text-align:center;" >Taxes</th>
                            <th style="text-align:right;" >SubTotal</th>
                        </tr>
                </thead>
                <tbody class="sale_tbody">
                        <t t-set="xvar_price_subtotal"   t-value="0.0"/>
                        <t t-set="xvar_price_tax"        t-value="0.0"/>
                        <t t-set="xvar_price_total"      t-value="0.0"/>                            
                    
                        <t t-foreach="doc.task_ids" t-as="l">
                            <t t-set="var_price_subtotal"   t-value="0.0"/>
                            <t t-set="var_price_tax"        t-value="0.0"/>
                            <t t-set="var_price_total"      t-value="0.0"/>                            
                            <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 9px;">
                                <td colspan="7">Task: <span t-field="l.name"/></td>
                            </tr>
                            <tr style="font-size: 9px;">
                                <!--<td><span t-field="l.task_id.complete_name"/></td>-->
                                <td><span t-field="l.name"/></td>
                                <td style="text-align:right;" ><span t-field="l.product_uom_qty" /></td>
                                <td style="text-align:right;" ><span t-field="l.product_uom.name" /></td>
                                <td style="text-align:right;" ><span t-field="l.price_unit" /></td>
                                <td style="text-align:center;" ><span t-esc="', '.join(map(lambda x: (x.description or x.name), l.tax_id))"/></td>
                                <td style="text-align:right;" ><span t-field="l.price_subtotal" /></td>
                            </tr>
                            <t t-set="var_price_subtotal"   t-value="var_price_subtotal + l.price_subtotal"/>
                            <t t-set="var_price_tax"        t-value="var_price_tax + l.price_tax"/>
                            <t t-set="var_price_total"      t-value="var_price_total + l.price_total"/>
                            <t t-if="l.spares_quotation_line_ids">
                                <t t-foreach="l.spares_quotation_line_ids" t-as="spares">
                                    <tr style="font-size: 9px;">
                                        <!--<td><span t-field="spares.product_id.complete_name"/></td>-->
                                        <td>>><span t-field="spares.name"/></td>
                                        <td style="text-align:right;" ><span t-field="spares.product_uom_qty" /></td>
                                        <td style="text-align:right;" ><span t-field="spares.product_uom.name" /></td>
                                        <td style="text-align:right;" ><span t-field="spares.price_unit" /></td>
                                        <td style="text-align:center;" ><span t-esc="', '.join(map(lambda x: (x.description or x.name), spares.tax_id))"/></td>
                                        <td style="text-align:right;" ><span t-field="spares.price_subtotal" /></td>
                                    </tr>
                                    <t t-set="var_price_subtotal"   t-value="var_price_subtotal + spares.price_subtotal"/>
                                    <t t-set="var_price_tax"        t-value="var_price_tax + spares.price_tax"/>
                                    <t t-set="var_price_total"      t-value="var_price_total + spares.price_total"/>                                    
                                </t>
                            </t>
                            <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 9px;">
                                <td style="text-align:right;" colspan="5"><strong><span t-field="l.task_id.name"/> Subtotal: </strong></td>
                                <td style="text-align:right;"><t t-esc="'{0:,.2f}'.format(int(var_price_subtotal))" /></td>
                            </tr>
                            <t t-set="xvar_price_subtotal"   t-value="var_price_subtotal + var_price_subtotal"/>
                            <t t-set="xvar_price_tax"   t-value="xvar_price_tax + var_price_tax"/>
                            <t t-set="xvar_price_total"   t-value="xvar_price_total + var_price_total"/>
                        </t>
                    </tbody>
                    <tfoot class="sale_tbody">                    
                        <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 9px;">
                            <td style="text-align:right;font-size: 9px;" colspan="5"><strong>Subtotal (All Tasks): </strong></td>
                            <td style="text-align:right;font-size: 9px"><t t-esc="'{0:,.2f}'.format(int(xvar_price_subtotal))" /></td>
                        </tr>
                        <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 9px;">
                            <td style="text-align:right;font-size: 9px;" colspan="5"><strong>Taxes: </strong></td>
                            <td style="text-align:right;font-size: 9px"><t t-esc="'{0:,.2f}'.format(int(xvar_price_tax))" /></td>
                        </tr>
                        <tr style="font-weight:bold;background-color: #f2f2f2;font-size: 9px;">
                            <td style="text-align:right;font-size: 9px;" colspan="5"><strong>Total: </strong></td>
                            <td style="text-align:right;font-size: 9px"><t t-esc="'{0:,.2f}'.format(int(xvar_price_total))" /></td>
                        </tr>
                    </tfoot>
                </table>
                <p t-field="doc.note" />                
            </div>
        </t>
    </template>


    <template id="report_mro_order_quotation">
        <t t-set="data_report_margin_top" t-value="20"/> 
        <t t-set="data_report_header_spacing" t-value="10"/>
        <t t-set="data_report_dpi" t-value="600"/>    
        <t t-call="report.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="fleet_mro.report_mro_order_quotation_document" t-lang="doc.partner_id.lang"/>
            </t>
        </t>
    </template>
</odoo>
